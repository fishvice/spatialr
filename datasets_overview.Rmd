---
title: ""
output:
  html_document:
    fig_height: 4
    fig_width: 8
    highlight: haddock
    theme: united
    toc: yes
    toc_float: yes
---

```{r, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# Preamble
___

The data used as examples in the course are all stored at this location [ftp://ftp.hafro.is/pub/data](ftp://ftp.hafro.is/pub/data). To obtain the path for reading any file into R it is simplest to:

* Go to the site using a browser
* Find the file of interest
* Right click on the filename and copy linklocation
* Paste the path into our R-script

The content of the directory is as follows:

```{bash, echo = FALSE, comment=NA}
tree  /net/www/export/home/ftp/pub/data
```

# Data
___

```{r setup}
library(mapdeck)
library(sf)
library(rmapshaper)
library(lwgeom)
library(tidyverse)
```

```{r, echo = FALSE}
key <- "pk.eyJ1IjoiZmlzaHZpY2UiLCJhIjoiY2p0MXQ5dThpMDZqeDQ5bHM0MGx4dHI5cyJ9.Fed_z7mv_TgTWDRjiavU3A" 
```


## Minke

The minke whale dataset contains biological measurements from 192 scientific catches of minke whales between the year 2003 and 2007. The data set contains the following variables:

* **whale.id**: Unique identifier for the whale
* **date.caught**: the date when the whales was caught
* **lat**: latitude
* **lon**: longitude
* **area**: Derived from location (North/South)
* **length**: length of the whale
* **weight**: weight of the whale
* **age**: age of the whale
* **sex**: Male or Female
* **maturity**: maturity status of the whale
* **stomach.volume**: volume (in liters) of the stomach content
* **stomach.weight**: weight of the stomach content
* **year**: the year when the whale was caught

**To read the data into R**:

```{r, eval = FALSE}
minke <- 
  read.csv("ftp://ftp.hafro.is/pub/data/csv/minke.csv",
           stringsAsFactors = FALSE) %>% 
  as_tibble()
```

## IESSNS 2019 survey

### trail

Dataset contains VMS tracks of 5 vessels that participated in IESSNS 2019 survey (often named the Pelagic Mackerel Survey). The variables are:

* **vessel**: The vessel name
* **time**: Time in UTC
* **lon**: Degrees longitude
* **lat**: Degrees latitute
* **speed**: Vessel speed in knots
* **heading**: Vessel heading in dregrees

```{r, eval = FALSE}
trail <- 
  read.csv("ftp://ftp.hafro.is/pub/data/csv/iessns2019_trail.csv",
           stringsAsFactors = FALSE) %>% 
  as_tibble()
trail %>% glimpse()
```

### tows

Dataset contains pre-determined pelagic trawl stations. The variables are:

* **activity**: Some information on the type of tow
* **lon**: Degrees longitude
* **lat**: Degrees latitute

```{r, eval = FALSE}
tows <- 
  read.csv("ftp://ftp.hafro.is/pub/data/csv/iessns2019_tows.csv",
           stringsAsFactors = FALSE) %>% 
  as_tibble()
tows %>% glimpse()
```

### strata

Dataset contains the survey stratas (used when calculating the stratified abundance/biomass indices). The variables are:

* **lon**: Degrees longitude
* **lat**: Degrees latitute
* **strata**: Numerical indicating strata number

```{r, eval = FALSE}
strata <- 
  read.csv("ftp://ftp.hafro.is/pub/data/csv/iessns2019_strata.csv",
           stringsAsFactors = FALSE) %>% 
  as_tibble()
strata %>% glimpse()
```

## DATRAS data


```{r, eval = FALSE}
hh <- 
  read_rds("/net/hafkaldi/export/home/haf/einarhj/prj2/bookdown/datrasdoodle/data/datras/hh_datras.rds") %>% 
  filter(year == 2018)
write_csv(hh, "/net/www/export/home/ftp/pub/data/csv/datras_2018_haul.csv")
hl <- 
  hh %>% 
  select(id) %>% 
  left_join(read_rds("/net/hafkaldi/export/home/haf/einarhj/prj2/bookdown/datrasdoodle/data/datras/hl_datras.rds"))
write_csv(hl, "/net/www/export/home/ftp/pub/data/csv/datras_2018_length.csv")
```

```{r}
hh <- read.csv("ftp://ftp.hafro.is/pub/data/csv/datras_2018_haul.csv",
               stringsAsFactors = FALSE)
hl <- read.csv("ftp://ftp.hafro.is/pub/data/csv/datras_2018_length.csv",
               stringsAsFactors = FALSE)
```


# Shapes
___


### ICES shapes


... create an interactive map showing all shapes

### ICES shapes code

The following shapes were obtained from gis.ices.dk. The primary purpose for storing them here was:

* Storing each as a single files in "gpkg"-format rather numerous ESRI-shapefiles that are bundled within each zip-file.
* Check shape validity.
* Create consistent variable names.
* Simplifying some very dense files in order to reduce usage of memory space when read into R.

The code shows how the data were obtained, and in case of simplification how they were simplified.

**A little helper function**:

```{r}
read_zipped_shapes <- function(url, simplify = FALSE, make_valid = TRUE) {
  td <- tempdir()
  tf <- tempfile()
  download.file(url, tf)
  fil <- unzip(tf, exdir = td)
  fil <- fil[grep(".shp$", fil)]
  if(length(fil) == 1) {
    sp <- 
      sf::read_sf(fil)
    #if(url %in% c("http://gis.ices.dk/shapefiles/ICES_ecoregions.zip",
    #              "ftp://ftp.hafro.is/pub/data/shapes/ices_areas.gpkg")) {
    #  bb <- sf::st_bbox(sp)
    #  bb[[4]] <- 89
    #  sp <- sf::st_crop(sp, bb)
    #}
  } else {
    res <- map(fil, sf::read_sf)
    names(res) <- 
      basename(fil) %>% 
      stringr::str_remove(".shp")
    sp <- 
      data.table::rbindlist(res,
                            use.names = TRUE,
                            fill = TRUE,
                            idcol = "name") %>%
      sf::st_as_sf()
  }
  
  sp <-
    sp %>% 
    dplyr::rename_all(tolower)
  file.remove(fil)
  
  if(!all(st_is_valid(sp)) & make_valid) {
    sp <- sp %>% lwgeom::st_make_valid()
  }
  
  if(simplify) sp <- rmapshaper::ms_simplify(sp)

  if(is.na(st_crs(sp)$epsg)) {
    # assume it is 4326
    sp <- sp %>% st_set_crs(value = 4326)
  } else {
    if(st_crs(sp)$epsg != 4326) sp <- sp %>% st_transform(crs = 4326)
  }
  
  return(sp)
  
}
```


#### Nephrops functional units

**reading**:
```{r, eval = FALSE}
url <- "http://gis.ices.dk/shapefiles/Nephrops_FU.zip"
p <- 
  read_zipped_shapes(url) %>%
  select(name = fu_descrip, fu)
write_sf(p, "/net/www/export/home/ftp/pub/data/shapes/nephrops_fu.gpkg")
```

**view**:
```{r}
p <- read_sf("ftp://ftp.hafro.is/pub/data/shapes/nephrops_fu.gpkg")
p %>% 
  mapdeck(token = key) %>% 
  add_polygon(fill_colour = "name",
              tooltip = "name",
              stroke_colour = adjustcolor("red", alpha.f = 1),
              stroke_width = 1000)
```

#### ICES areas

```{r, eval = FALSE}
url <- "http://gis.ices.dk/shapefiles/ICES_areas.zip"
p <-
  read_zipped_shapes(url, simplify = TRUE)
write_sf(p, "/net/www/export/home/ftp/pub/data/shapes/ices_areas.gpkg")
```

**view**:
```{r}
p <- read_sf("ftp://ftp.hafro.is/pub/data/shapes/ices_areas.gpkg")
p %>% 
  mapdeck(token = key) %>% 
  add_polygon(fill_colour = "area_27",
         tooltip = "area_27",
         stroke_colour = adjustcolor("red", alpha.f = 1),
         stroke_width = 1000)
```

#### ICES ecoregions

```{r, eval = FALSE}
url <- "http://gis.ices.dk/shapefiles/ICES_ecoregions.zip"
p <- 
  read_zipped_shapes(url, simplify = TRUE) %>% 
  select(ecoregion,
         area_km2 = shape_area)
p %>% write_sf("/net/www/export/home/ftp/pub/data/shapes/ices_ecoregions.gpkg")
```

**view**:
```{r}
p <- read_sf("ftp://ftp.hafro.is/pub/data/shapes/ices_ecoregions.gpkg")
p %>% 
  mapdeck(token = key) %>% 
  add_polygon(fill_colour = "ecoregion", 
         tooltip = "ecoregion",
         #palette = "rainbow",
         stroke_colour = adjustcolor("red", alpha.f = 1),
         stroke_width = 10000)
```

#### OSPAR (from ICES)

```{r, eval = FALSE}
url <- "http://gis.ices.dk/shapefiles/OSPAR_Subregions.zip"
p <- read_zipped_shapes(url) 
p %>% write_sf("/net/www/export/home/ftp/pub/data/shapes/ospar.gpkg")
```

**view**:
```{r}
p <- read_sf("ftp://ftp.hafro.is/pub/data/shapes/ospar.gpkg")
p %>% 
  mapdeck(token = key) %>% 
  add_sf(fill_colour = "subregion",
         tooltip = "subregion",
         stroke_colour = adjustcolor("red", alpha.f = 1),
         stroke_width = 10000)
```

#### HELOM (from ICES)

```{r, eval = FALSE}
url <- "http://gis.ices.dk/shapefiles/HELCOM_subbasins.zip"
p <- read_zipped_shapes(url, simplify = TRUE)
p %>% write_sf("/net/www/export/home/ftp/pub/data/shapes/helcom.gpkg")
```

**view**:
```{r}
p <- read_sf("ftp://ftp.hafro.is/pub/data/shapes/helcom.gpkg")
p %>% 
  mapdeck(token = key) %>% 
  add_sf(fill_colour = "name",
         tooltip = "name",
         stroke_colour = adjustcolor("red", alpha.f = 1),
         stroke_width = 500)
```

#### ICES statistical rectangles

```{r, eval = FALSE}
url <- "http://gis.ices.dk/shapefiles/ICES_rectangles.zip" 
p <- read_zipped_shapes(url)
write_sf("/net/www/export/home/ftp/pub/data/shapes/ices_rectangles.gpkg")
```

#### ICES statistical subrectangles

```{r, eval = FALSE}
url <- "http://gis.ices.dk/shapefiles/ICES_SubStatrec.zip" 
p <- read_zipped_shapes(url)
p %>% 
  write_sf("/net/www/export/home/ftp/pub/data/shapes/ices_subrectangles.gpkg")
```

#### NEAFC vme

Not really what was expected

```{r, eval = FALSE}
# bit of a mess
url <- "https://www.neafc.org/system/files/mid-atlantic-vme-closures.zip"
p1 <- read_zipped_shapes(url)
url <- "https://www.neafc.org/system/files/hr_shape_files_2018.zip"
p2 <- read_zipped_shapes(url)
library(mapdeck)
key <- "pk.eyJ1IjoiZmlzaHZpY2UiLCJhIjoiY2p0MXQ5dThpMDZqeDQ5bHM0MGx4dHI5cyJ9.Fed_z7mv_TgTWDRjiavU3A"
p1 %>% mapdeck(token = key) %>% add_sf(tooltip = "name")
p2 %>% mapdeck(token = key) %>% add_sf(tooltip = "name")
p %>% write_sf("/net/www/export/home/ftp/pub/data/shapes/helcom.gpkg")
```



# Not there yet

### Datras data

Download available 2019 DATRAS data:
```{r, eval = FALSE}

 
```

```{r, eval = FALSE}
library(icesDatras)
library(tidyices)
yrs <- 2000:2019
qts <- c(1, 3)
hh <- 
  getDATRAS(record = "HH", survey = "NS-IBTS", years = yrs, quarters = qts) %>% 
  dtrs_tidy_hh()
species <- read_csv("ftp://ftp.hafro.is/pub/reiknid/einar/datras_worms.csv")
hl <- 
  getDATRAS(record = "HL", survey = "NS-IBTS", years = yrs, quarters = qts) %>% 
  dtrs_tidy_hl(hh, species)
write_csv(hh, "/net/www/export/home/ftp/pub/reiknid/einar/data/datras/nsibts_hh.csv", na = "")  
write_csv(hl, "/net/www/export/home/ftp/pub/reiknid/einar/data/datras/nsibts_hl.csv", na = "")  
```


